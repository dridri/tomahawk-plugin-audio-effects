#include <QWidget>
#include <QtPlugin>
#include <cmath>
#include <utils/Logger.h>

#include "Loudness.h"

float Loudness::f_lowpass[LP_SIZE] = {
  -0.0053936566329856,
  -0.0008244017399255017,
  -0.0009452043175523657,
  -0.0009557587977505577,
  -0.001079834426946225,
  -0.0010928204361596813,
  -0.0012195986899950358,
  -0.0012343594920374572,
  -0.0013632242576835135,
  -0.0013791052414561372,
  -0.001509372646634345,
  -0.0015256578400984079,
  -0.0016566054198896244,
  -0.0016725906852988583,
  -0.0018034273881529412,
  -0.0018182331412825027,
  -0.0019480307722216407,
  -0.001960759502356337,
  -0.0020886296501846082,
  -0.002098352792077547,
  -0.002223275783884811,
  -0.0022289203810628867,
  -0.002349827985737944,
  -0.002350405694318151,
  -0.002466382642919065,
  -0.0024610073175511996,
  -0.0025711012604334813,
  -0.002558747297617118,
  -0.0026619266656651604,
  -0.002641682488465343,
  -0.0027371687757349415,
  -0.0027082778907081624,
  -0.0027952303013904787,
  -0.002756798945411448,
  -0.002834482788694891,
  -0.0027859286652924184,
  -0.0028538081882769923,
  -0.002794204567973236,
  -0.002851513243813263,
  -0.002780446594067063,
  -0.0028265014886004946,
  -0.0027436098949910497,
  -0.002777898523875268,
  -0.0026825279362825854,
  -0.002705028149592168,
  -0.002597198877718118,
  -0.00260783547720911,
  -0.002487254428563347,
  -0.0024861635242181897,
  -0.002353403043671058,
  -0.002340887478621904,
  -0.0021961181320260367,
  -0.002172448506932488,
  -0.0020162080193542207,
  -0.00198204539616053,
  -0.0018148730712398476,
  -0.001770609015506753,
  -0.0015928689228469977,
  -0.0015390694576350825,
  -0.0013515655655947155,
  -0.0012892688705722338,
  -0.0010931672470406433,
  -0.0010236830734216909,
  -0.0008204300935873416,
  -0.000745378878253441,
  -0.0005366922136271392,
  -0.0004577511308971622,
  -0.000245087081432286,
  -0.00016337149491777025,
  0.00005240503671797028,
  0.00013610246112631333,
  0.00035388833704562693,
  0.00043794194615922737,
  0.0006552085177627546,
  0.0007363795575912999,
  0.0009494034737147786,
  0.0010250092700804139,
  0.0012328815556176117,
  0.0013054301523240503,
  0.0015108506047589224,
  0.0015796326887247377,
  0.0017644890728210532,
  0.001825020962084034,
  0.0020101503048229673,
  0.0020534129273716683,
  0.0022273726593368018,
  0.0022588843212549992,
  0.0024193131219046623,
  0.002436858624572296,
  0.0025825804820332923,
  0.002584526732061223,
  0.0027142339005240992,
  0.0026992916085548627,
  0.0028118667267470567,
  0.0027788854464950363,
  0.002873310626309524,
  0.002821426889306703,
  0.002897030953461406,
  0.002825650690529206,
  0.0028818701686277206,
  0.0027904601350299137,
  0.0028268694149401682,
  0.0027151630431207015,
  0.0027316808300107877,
  0.0025997475499706896,
  0.0025965586387694663,
  0.0024446702078304333,
  0.00242217985914357,
  0.0022509272076361307,
  0.002209930780801307,
  0.0020202353921602743,
  0.0019617101097704347,
  0.001754643142649075,
  0.0016798623467053615,
  0.001456968086896112,
  0.0013675614155612937,
  0.001130472698628378,
  0.0010280140247234963,
  0.0007787989757813197,
  0.0006654009589048734,
  0.0004059071582494618,
  0.0002842430317046638,
  0.000016472319365973646,
  -0.00011140846405290239,
  -0.0003839209398842823,
  -0.000515381993618374,
  -0.0007904758106010495,
  -0.000922689711375325,
  -0.00119695286535867,
  -0.0013267957900132468,
  -0.0015977964342128606,
  -0.0017226479501483724,
  -0.001987330394213587,
  -0.0021038163045687267,
  -0.0023588784913920573,
  -0.002463935937278432,
  -0.002706377078216093,
  -0.0027969042230167407,
  -0.003023446438793833,
  -0.0030962207218907458,
  -0.0033038272418909947,
  -0.003356128410270368,
  -0.003542226458473751,
  -0.0035715156172318723,
  -0.003733378087313305,
  -0.003736775285857956,
  -0.0038714250498409464,
  -0.0038461252932433876,
  -0.003951079309933033,
  -0.0038950627821697573,
  -0.003968683468502701,
  -0.0038805070055705627,
  -0.003921217168270693,
  -0.0037988785560358037,
  -0.003804346694912568,
  -0.0036456526527671967,
  -0.0036147296459049594,
  -0.0034196819148504124,
  -0.003353144287016133,
  -0.0031210385417288137,
  -0.003016487256565394,
  -0.0027447835861238467,
  -0.002605436471209727,
  -0.0022971874697050366,
  -0.0021183429448907265,
  -0.0017744764269425825,
  -0.0015594794682681572,
  -0.001179332109701958,
  -0.0009295238339396963,
  -0.0005147246971717678,
  -0.0002314705798874817,
  0.00021608558888878046,
  0.0005308106643580137,
  0.0010090156544336538,
  0.0013530205815880617,
  0.0018593904591696572,
  0.002229924946684554,
  0.0027615032768925976,
  0.0031555154166874023,
  0.0037091390675157055,
  0.004123325217673523,
  0.004695514100194856,
  0.0051262511256650115,
  0.005713253700644428,
  0.006156697783979336,
  0.006754556467643273,
  0.007206641904232159,
  0.007811142818975553,
  0.008267555355891828,
  0.00887432502611767,
  0.009330724416503787,
  0.009935420440775606,
  0.010387411104315226,
  0.010985539977762583,
  0.011428620247941031,
  0.012015787604076754,
  0.01244558651735083,
  0.013017356198293436,
  0.013429187251088293,
  0.013981267904908173,
  0.014370884867633198,
  0.014898465424849083,
  0.015262862866028433,
  0.015761622663635115,
  0.016095319163315174,
  0.01656320626963828,
  0.016863143290863077,
  0.017295161923802288,
  0.017557373791362213,
  0.017950864565815888,
  0.018173090397794155,
  0.018524947171870598,
  0.018703915267552218,
  0.019011235368437535,
  0.019144826219372427,
  0.01940594252971855,
  0.019492521953557246,
  0.019705603097832633,
  0.01974327897794988,
  0.019906685902749074,
  0.019894277857960146,
  0.020007366013600238,
  0.01994461710492715,
  0.020007366013600238,
  0.019894277857960146,
  0.019906685902749074,
  0.01974327897794988,
  0.019705603097832633,
  0.019492521953557246,
  0.01940594252971855,
  0.019144826219372427,
  0.019011235368437535,
  0.018703915267552218,
  0.018524947171870598,
  0.018173090397794155,
  0.017950864565815888,
  0.017557373791362213,
  0.017295161923802288,
  0.016863143290863077,
  0.01656320626963828,
  0.016095319163315174,
  0.015761622663635115,
  0.015262862866028433,
  0.014898465424849083,
  0.014370884867633198,
  0.013981267904908173,
  0.013429187251088293,
  0.013017356198293436,
  0.01244558651735083,
  0.012015787604076754,
  0.011428620247941031,
  0.010985539977762583,
  0.010387411104315226,
  0.009935420440775606,
  0.009330724416503787,
  0.00887432502611767,
  0.008267555355891828,
  0.007811142818975553,
  0.007206641904232159,
  0.006754556467643273,
  0.006156697783979336,
  0.005713253700644428,
  0.0051262511256650115,
  0.004695514100194856,
  0.004123325217673523,
  0.0037091390675157055,
  0.0031555154166874023,
  0.0027615032768925976,
  0.002229924946684554,
  0.0018593904591696572,
  0.0013530205815880617,
  0.0010090156544336538,
  0.0005308106643580137,
  0.00021608558888878046,
  -0.0002314705798874817,
  -0.0005147246971717678,
  -0.0009295238339396963,
  -0.001179332109701958,
  -0.0015594794682681572,
  -0.0017744764269425825,
  -0.0021183429448907265,
  -0.0022971874697050366,
  -0.002605436471209727,
  -0.0027447835861238467,
  -0.003016487256565394,
  -0.0031210385417288137,
  -0.003353144287016133,
  -0.0034196819148504124,
  -0.0036147296459049594,
  -0.0036456526527671967,
  -0.003804346694912568,
  -0.0037988785560358037,
  -0.003921217168270693,
  -0.0038805070055705627,
  -0.003968683468502701,
  -0.0038950627821697573,
  -0.003951079309933033,
  -0.0038461252932433876,
  -0.0038714250498409464,
  -0.003736775285857956,
  -0.003733378087313305,
  -0.0035715156172318723,
  -0.003542226458473751,
  -0.003356128410270368,
  -0.0033038272418909947,
  -0.0030962207218907458,
  -0.003023446438793833,
  -0.0027969042230167407,
  -0.002706377078216093,
  -0.002463935937278432,
  -0.0023588784913920573,
  -0.0021038163045687267,
  -0.001987330394213587,
  -0.0017226479501483724,
  -0.0015977964342128606,
  -0.0013267957900132468,
  -0.00119695286535867,
  -0.000922689711375325,
  -0.0007904758106010495,
  -0.000515381993618374,
  -0.0003839209398842823,
  -0.00011140846405290239,
  0.000016472319365973646,
  0.0002842430317046638,
  0.0004059071582494618,
  0.0006654009589048734,
  0.0007787989757813197,
  0.0010280140247234963,
  0.001130472698628378,
  0.0013675614155612937,
  0.001456968086896112,
  0.0016798623467053615,
  0.001754643142649075,
  0.0019617101097704347,
  0.0020202353921602743,
  0.002209930780801307,
  0.0022509272076361307,
  0.00242217985914357,
  0.0024446702078304333,
  0.0025965586387694663,
  0.0025997475499706896,
  0.0027316808300107877,
  0.0027151630431207015,
  0.0028268694149401682,
  0.0027904601350299137,
  0.0028818701686277206,
  0.002825650690529206,
  0.002897030953461406,
  0.002821426889306703,
  0.002873310626309524,
  0.0027788854464950363,
  0.0028118667267470567,
  0.0026992916085548627,
  0.0027142339005240992,
  0.002584526732061223,
  0.0025825804820332923,
  0.002436858624572296,
  0.0024193131219046623,
  0.0022588843212549992,
  0.0022273726593368018,
  0.0020534129273716683,
  0.0020101503048229673,
  0.001825020962084034,
  0.0017644890728210532,
  0.0015796326887247377,
  0.0015108506047589224,
  0.0013054301523240503,
  0.0012328815556176117,
  0.0010250092700804139,
  0.0009494034737147786,
  0.0007363795575912999,
  0.0006552085177627546,
  0.00043794194615922737,
  0.00035388833704562693,
  0.00013610246112631333,
  0.00005240503671797028,
  -0.00016337149491777025,
  -0.000245087081432286,
  -0.0004577511308971622,
  -0.0005366922136271392,
  -0.000745378878253441,
  -0.0008204300935873416,
  -0.0010236830734216909,
  -0.0010931672470406433,
  -0.0012892688705722338,
  -0.0013515655655947155,
  -0.0015390694576350825,
  -0.0015928689228469977,
  -0.001770609015506753,
  -0.0018148730712398476,
  -0.00198204539616053,
  -0.0020162080193542207,
  -0.002172448506932488,
  -0.0021961181320260367,
  -0.002340887478621904,
  -0.002353403043671058,
  -0.0024861635242181897,
  -0.002487254428563347,
  -0.00260783547720911,
  -0.002597198877718118,
  -0.002705028149592168,
  -0.0026825279362825854,
  -0.002777898523875268,
  -0.0027436098949910497,
  -0.0028265014886004946,
  -0.002780446594067063,
  -0.002851513243813263,
  -0.002794204567973236,
  -0.0028538081882769923,
  -0.0027859286652924184,
  -0.002834482788694891,
  -0.002756798945411448,
  -0.0027952303013904787,
  -0.0027082778907081624,
  -0.0027371687757349415,
  -0.002641682488465343,
  -0.0026619266656651604,
  -0.002558747297617118,
  -0.0025711012604334813,
  -0.0024610073175511996,
  -0.002466382642919065,
  -0.002350405694318151,
  -0.002349827985737944,
  -0.0022289203810628867,
  -0.002223275783884811,
  -0.002098352792077547,
  -0.0020886296501846082,
  -0.001960759502356337,
  -0.0019480307722216407,
  -0.0018182331412825027,
  -0.0018034273881529412,
  -0.0016725906852988583,
  -0.0016566054198896244,
  -0.0015256578400984079,
  -0.001509372646634345,
  -0.0013791052414561372,
  -0.0013632242576835135,
  -0.0012343594920374572,
  -0.0012195986899950358,
  -0.0010928204361596813,
  -0.001079834426946225,
  -0.0009557587977505577,
  -0.0009452043175523657,
  -0.0008244017399255017,
  -0.0053936566329856
};

float Loudness::f_highpass[HP_SIZE] = {
  -0.05649833983302811,
  0.07999426531721648,
  0.02609519549605755,
  -0.013333319037201852,
  -0.03874892451613713,
  -0.03903924447644743,
  -0.00916854538289973,
  0.03683221185243168,
  0.06649707869921016,
  0.04645393555374808,
  -0.03468322967497165,
  -0.15259634060109614,
  -0.2574634713076423,
  0.7008350724785379,
  -0.2574634713076423,
  -0.15259634060109614,
  -0.03468322967497165,
  0.04645393555374808,
  0.06649707869921016,
  0.03683221185243168,
  -0.00916854538289973,
  -0.03903924447644743,
  -0.03874892451613713,
  -0.013333319037201852,
  0.02609519549605755,
  0.07999426531721648,
  -0.05649833983302811
};


static Loudness* plugin_instance = 0;


Loudness* Loudness::instance()
{
    return plugin_instance;
}


Loudness::Loudness()
	: QObject( 0 )
    , m_loudnessUi ( new Ui::Loudness )
    , m_basslevel( 0 )
    , m_treblelevel( 0 )
{
	tDebug() << Q_FUNC_INFO;

    plugin_instance = this;
    mainWidget = new QWidget();
    m_loudnessUi->setupUi( mainWidget );

    QObject::connect( m_loudnessUi->bass, SIGNAL( sliderMoved ( int ) ), this, SLOT( changeBass( int ) ) );
    QObject::connect( m_loudnessUi->treble, SIGNAL( sliderMoved ( int ) ), this, SLOT( changeTreble( int ) ) );
}


Loudness::~Loudness()
{
	tDebug() << Q_FUNC_INFO;
}


QString
Loudness::title()
{
    return "Loudness";
}


QWidget*
Loudness::widget()
{
	tDebug() << Q_FUNC_INFO;

	return mainWidget;
}


void
Loudness::changeBass( int value )
{
    m_basslevel = value;
}


void
Loudness::changeTreble( int value )
{
    m_treblelevel = value;
}


void
Loudness::FirFixed( float* buffer, int len, float* coeffs, int coeffslen, float level )
{
    static float in[2][2048*2] = { { 0 } };
    float acc0, acc1;
    int i;
    int n;
    int j;

    // Put new data into buffer
    for(i=0; i<len; i++){
        in[0][coeffslen-1 + i] = buffer[i * 2 + 0];
        in[1][coeffslen-1 + i] = buffer[i * 2 + 1];
    }

    for(n=0; n<len; n++){
        acc0 = acc1 = 0.0f;
        for(j = 0; j<coeffslen; j++){
            acc0 += coeffs[j] * in[0][coeffslen - 1 + n - j];
            acc1 += coeffs[j] * in[1][coeffslen - 1 + n - j];
        }
        buffer[n * 2 + 0] = buffer[n * 2 + 0] * ( 1.0f - level ) + acc0 * level;
        buffer[n * 2 + 1] = buffer[n * 2 + 1] * ( 1.0f - level ) + acc1 * level;
    }
    
    // Shift data back in time for next pass
    for(i=0; i<coeffslen-1; i++){
        in[0][i] = in[0][len + i];
        in[1][i] = in[1][len + i];
    }
}


void
Loudness::processData( float* samples, int nb_channels, int nb_samples )
{
    FirFixed( samples, nb_samples, f_lowpass, LP_SIZE, (float)m_basslevel / 100.0f );
//    FirFixed( samples, nb_samples, f_highpass, HP_SIZE, (float)m_treblelevel / 100.0f );
}

Q_EXPORT_PLUGIN2( loudness, Loudness )
